# yaml-language-server: $schema=https://api.cerbos.dev/latest/cerbos/policy/v1/Policy.schema.json
---
apiVersion: api.cerbos.dev/v1
variables:
  is_vendor_star: P.attr.tenants["*"] != null
resourcePolicy:
  version: "default"
  resource: account
  schemas:
    principalSchema: 
      ref: cerbos:///principal.json
    resourceSchema: 
      ref: cerbos:///account.json
      ignoreWhen: 
        actions: ["create"]
  rules:
  - name: vendor_star_can_view_any
    actions: ["view"]
    roles: ["user"]
    effect: EFFECT_ALLOW
    condition:
      match:
        expr: V.is_vendor_star

  - name: vendor_star_with_contract_admin_can_edit_any
    actions: ["edit"]
    roles: ["user"]
    effect: EFFECT_ALLOW
    condition:
      match:
        all:
          of:
            - expr: V.is_vendor_star
            - expr: P.attr.tenants["*"].attachments.exists_one(t, t.role == "Abacus_contract_admin")
  
  - name: you_can_view_your_tenant_account
    actions: ["view"]
    roles: ["user"]
    effect: EFFECT_ALLOW
    condition:
      match:
        expr: R.attr.account_id in P.attr.tenants
